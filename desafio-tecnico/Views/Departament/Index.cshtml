@{
    ViewData["Title"] = "Departamentos";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex flex-column gap-2">
            <h1 class="mb-0 fw-bold">Departamentos</h1>
            <p class="mt-0 text-muted">Carregando...</p>
        </div>
        <button class="btn btn-primary" onclick="openDepartamentModal('create')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
            </svg>
            Criar Departamento
        </button>
    </div>

    @{
        ViewBag.Columns = new List<string> { "Nome", "Gerente", "Departamento Superior" };
        ViewBag.TableId = "departamentTable";
        ViewBag.ApiUrl = "/api/departaments";
    }

    @await Html.PartialAsync("_PagedTable", new {
        Data = new List<object>(),
        CurrentPage = 1,
        PageSize = 10,
        TotalRecords = 0,
        TotalPages = 0,
        ItemsInPage = 0
    })
</div>

@await Html.PartialAsync("_DepartamentModal")

@section Scripts {
    <script src="~/js/pagedTable.js"></script>
    <script>
        if (typeof renderTableData === 'undefined') {
            console.warn('Aguardando carregamento de pagedTable.js...');
        }

        const apiUrl = '/api/departaments';
        let currentPage = 1;
        const pageSize = 10;

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadDepartaments(page = 1) {
            try {
                currentPage = page;
                const response = await fetch(`${apiUrl}?page=${currentPage}&pageSize=${pageSize}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const pagedData = await response.json();

                // atualizar total de registros
                const totalRecordsElement = document.querySelector('.d-flex.flex-column.gap-2 p');
                if (totalRecordsElement) {
                    totalRecordsElement.textContent = `${pagedData.totalRecords} departamento(s) cadastrado(s)`;
                }

                // carregar dados na tabela
                if (typeof renderTableData === 'function') {
                    renderTableData('departamentTable', pagedData.data, (item) => {
                    return `
                        <td>${escapeHtml(item.name || '')}</td>
                        <td>${escapeHtml(item.manager?.name || 'Sem gerente')}</td>
                        <td>${escapeHtml(item.higherDepartament?.name || 'Nenhum')}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewDepartament(${item.id})" title="Ver detalhes">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDepartament(${item.id})" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.293a.5.5 0 0 1-.353-.146l-.854-.854z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartament(${item.id})" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                </svg>
                            </button>
                        </td>
                    `;
                    });
                } else {
                    console.error('Função renderTableData não encontrada. Verifique se pagedTable.js está carregado.');
                }

                updatePagination(pagedData);
            } catch (error) {
                console.error('Erro ao carregar departamentos:', error);
                const pagedData = {
                    data: [],
                    currentPage: currentPage,
                    pageSize: pageSize,
                    totalRecords: 0,
                    totalPages: 0,
                    itemsInPage: 0
                };
                if (typeof renderTableData === 'function') {
                    renderTableData('departamentTable', [], () => '');
                }
                updatePagination(pagedData);
            }
        }

        function updatePagination(pagedData) {
            const cardBody = document.querySelector('#departamentTable').closest('.card-body');
            if (!cardBody) return;

            let nav = cardBody.querySelector('nav');
            if (!nav) {
                // criar nav se não existir
                nav = document.createElement('nav');
                nav.setAttribute('aria-label', 'Paginação');
                const tableContainer = cardBody.querySelector('.table-responsive');
                if (tableContainer) {
                    tableContainer.after(nav);
                } else {
                    cardBody.appendChild(nav);
                }
            }

            if (pagedData.totalPages <= 1 && pagedData.totalRecords === 0) {
                nav.style.display = 'none';
                return;
            }

            nav.style.display = 'block';
            
            let paginationDiv = nav.querySelector('.d-flex');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'd-flex justify-content-between align-items-center mt-3 flex-wrap gap-2';
                nav.appendChild(paginationDiv);
            }

            const startPage = Math.max(1, pagedData.currentPage - 2);
            const endPage = Math.min(pagedData.totalPages, pagedData.currentPage + 2);

            let paginationHTML = `
                <div class="text-muted">
                    ${pagedData.totalRecords > 0 
                        ? `Mostrando <strong>${(pagedData.currentPage - 1) * pagedData.pageSize + 1}</strong> a <strong>${(pagedData.currentPage - 1) * pagedData.pageSize + pagedData.itemsInPage}</strong> de <strong>${pagedData.totalRecords}</strong> registros`
                        : 'Nenhum registro encontrado'}
                </div>
            `;

            if (pagedData.totalPages > 1) {
                paginationHTML += `
                    <ul class="pagination mb-0">
                        <li class="page-item ${pagedData.currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="loadPage('departamentTable', ${pagedData.currentPage - 1}); return false;" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                `;

                if (startPage > 1) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="loadPage('departamentTable', 1); return false;">1</a>
                        </li>
                    `;
                    if (startPage > 2) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === pagedData.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadPage('departamentTable', ${i}); return false;">${i}</a>
                        </li>
                    `;
                }

                if (endPage < pagedData.totalPages) {
                    if (endPage < pagedData.totalPages - 1) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="loadPage('departamentTable', ${pagedData.totalPages}); return false;">${pagedData.totalPages}</a>
                        </li>
                    `;
                }

                paginationHTML += `
                        <li class="page-item ${pagedData.currentPage === pagedData.totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="loadPage('departamentTable', ${pagedData.currentPage + 1}); return false;" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                `;
            }

            paginationHTML += `
                <div class="text-muted">
                    ${pagedData.totalPages > 0 ? `Página <strong>${pagedData.currentPage}</strong> de <strong>${pagedData.totalPages}</strong>` : ''}
                </div>
            `;

            paginationDiv.innerHTML = paginationHTML;
        }

        let currentEditId = null;

        async function openDepartamentModal(mode, id = null) {
            const modalElement = document.getElementById('departamentModal');
            if (!modalElement) {
                console.error('Modal não encontrado');
                return;
            }

            currentEditId = id;
            const modal = new bootstrap.Modal(modalElement);
            const modalTitle = document.getElementById('departamentModalLabel');
            const form = document.getElementById('departamentForm');

            if (!form) {
                console.error('Formulário não encontrado');
                return;
            }

            form.reset();
            const departamentIdInput = document.getElementById('departamentId');
            if (departamentIdInput) {
                departamentIdInput.value = '';
            }

            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            const managerFieldContainer = document.getElementById('managerFieldContainer');
            
            if (mode === 'create') {
                modalTitle.textContent = 'Novo Departamento';
                document.getElementById('saveDepartamentText').textContent = 'Salvar';
                
                if (managerFieldContainer) {
                    managerFieldContainer.style.display = 'none';
                }
            } else {
                modalTitle.textContent = 'Editar Departamento';
                document.getElementById('saveDepartamentText').textContent = 'Atualizar';
                
                if (managerFieldContainer) {
                    managerFieldContainer.style.display = 'block';
                }
                
                // carregar dados do departamento para o modal
                try {
                    const response = await fetch(`${apiUrl}/${id}`);
                    if (response.ok) {
                        const departament = await response.json();
                        document.getElementById('departamentId').value = departament.id;
                        document.getElementById('departamentName').value = departament.name || '';
                        document.getElementById('departamentManagerId').value = departament.managerId ? departament.managerId.toString() : '';
                        document.getElementById('departamentHigherId').value = departament.higherDepartamentId ? departament.higherDepartamentId.toString() : '';
                    }
                } catch (error) {
                    console.error('Erro ao carregar departamento:', error);
                }
            }

            await loadModalSelects(id);
            
            modal.show();
        }

        async function loadModalSelects(excludeDepartamentId = null) {
            const managerFieldContainer = document.getElementById('managerFieldContainer');
            const isManagerFieldVisible = managerFieldContainer && managerFieldContainer.style.display !== 'none';
            
            // carregar employees para o select de gerente (apenas se o campo estiver visível)
            if (isManagerFieldVisible) {
                try {
                    const employeesResponse = await fetch('/api/employees?page=1&pageSize=1000');
                    if (employeesResponse.ok) {
                        const employeesData = await employeesResponse.json();
                        const managerSelect = document.getElementById('departamentManagerId');
                        const currentValue = managerSelect.value;
                        
                        // limpar opções exceto a primeira
                        managerSelect.innerHTML = '<option value="">Selecione um gerente (opcional)</option>';
                        
                        employeesData.data.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.id;
                            option.textContent = employee.name;
                            if (employee.id.toString() === currentValue) {
                                option.selected = true;
                            }
                            managerSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Erro ao carregar employees:', error);
                }
            }

            // carregar departamentos para o select de departamento superior
            try {
                const departamentsResponse = await fetch(`${apiUrl}?page=1&pageSize=1000`);
                if (departamentsResponse.ok) {
                    const departamentsData = await departamentsResponse.json();
                    const higherSelect = document.getElementById('departamentHigherId');
                    const currentValue = higherSelect.value;
                    
                    // limpar opções exceto a primeira
                    higherSelect.innerHTML = '<option value="">Nenhum</option>';
                    
                    departamentsData.data.forEach(departament => {
                        // não incluir o próprio departamento na lista de superiores
                        if (excludeDepartamentId && departament.id === excludeDepartamentId) {
                            return;
                        }
                        
                        const option = document.createElement('option');
                        option.value = departament.id;
                        option.textContent = departament.name;
                        if (departament.id.toString() === currentValue) {
                            option.selected = true;
                        }
                        higherSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar departamentos:', error);
            }
        }

        async function saveDepartament() {
            const form = document.getElementById('departamentForm');
            if (!form) {
                console.error('Formulário não encontrado');
                return;
            }

            const saveBtn = document.getElementById('saveDepartamentBtn');
            const spinner = document.getElementById('saveDepartamentSpinner');
            const saveText = document.getElementById('saveDepartamentText');

            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const departamentId = document.getElementById('departamentId').value;
            const isEdit = departamentId !== '';
            
            const managerFieldContainer = document.getElementById('managerFieldContainer');
            const isManagerFieldVisible = managerFieldContainer && managerFieldContainer.style.display !== 'none';
            
            const managerIdValue = isManagerFieldVisible ? document.getElementById('departamentManagerId').value : '';
            const higherIdValue = document.getElementById('departamentHigherId').value;
            
            const data = {
                name: document.getElementById('departamentName').value.trim(),
                managerId: isManagerFieldVisible && managerIdValue !== '' ? parseInt(managerIdValue) : null,
                higherDepartamentId: higherIdValue === '' ? null : parseInt(higherIdValue)
            };

            saveBtn.disabled = true;
            spinner.classList.remove('d-none');
            saveText.textContent = 'Salvando...';
            
            try {
                const url = isEdit ? `${apiUrl}/${departamentId}` : apiUrl;
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('Enviando requisição:', { url, method, data });
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    result = { message: text || 'Erro desconhecido' };
                }
                
                if (response.ok) {
                    // fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('departamentModal'));
                    modal.hide();
                    
                    loadDepartaments(currentPage);

                    alert(isEdit ? 'Departamento atualizado com sucesso!' : 'Departamento criado com sucesso!');
                } else {
                    const errorMessage = result.message || result.title || 'Erro ao salvar departamento';
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Erro ao salvar departamento:', error);
                alert('Erro ao salvar departamento. Tente novamente.');
            } finally {
                saveBtn.disabled = false;
                spinner.classList.add('d-none');
                saveText.textContent = isEdit ? 'Atualizar' : 'Salvar';
            }
        }

        function viewDepartament(id) {
            window.location.href = `/Departament/Details/${id}`;
        }

        function editDepartament(id) {
            openDepartamentModal('edit', id);
        }

        function deleteDepartament(id) {
            if (confirm('Tem certeza que deseja excluir este departamento?')) {
                fetch(`${apiUrl}/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadDepartaments(currentPage);
                    } else {
                        alert('Erro ao excluir departamento');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir departamento');
                });
            }
        }
        
        window.addEventListener('pagedTable:loadPage', (event) => {
            if (event.detail.tableId === 'departamentTable') {
                loadDepartaments(event.detail.page);
            }
        });

        // carregar dados ao abrir a pagina
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setTimeout(() => {
                    loadDepartaments(1);
                }, 100);
                
                const saveBtn = document.getElementById('saveDepartamentBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveDepartament);
                } else {
                    console.warn('Botão saveDepartamentBtn não encontrado');
                }
                
                const departamentModal = document.getElementById('departamentModal');
                if (departamentModal) {
                    departamentModal.addEventListener('hidden.bs.modal', () => {
                        const form = document.getElementById('departamentForm');
                        if (form) {
                            form.reset();
                            form.classList.remove('was-validated');
                            const departamentIdInput = document.getElementById('departamentId');
                            if (departamentIdInput) {
                                departamentIdInput.value = '';
                            }
                            const managerFieldContainer = document.getElementById('managerFieldContainer');
                            if (managerFieldContainer) {
                                managerFieldContainer.style.display = 'none';
                            }
                            currentEditId = null;
                        }
                    });
                } else {
                    console.warn('Modal departamentModal não encontrado');
                }
            } catch (error) {
                console.error('Erro ao inicializar página:', error);
            }
        });
    </script>
}
        