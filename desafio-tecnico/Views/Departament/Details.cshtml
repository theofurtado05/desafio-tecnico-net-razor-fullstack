@{
    ViewData["Title"] = "Detalhes do Departamento";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0 fw-bold">Detalhes do Departamento</h1>
            <p class="mt-2 text-muted">Carregando...</p>
        </div>
        <a href="/Departament" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
            </svg>
            Voltar
        </a>
    </div>

    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3 text-muted">Carregando dados do departamento...</p>
    </div>

    <div id="departamentDetails" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0" id="departamentName">-</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Informações Gerais</h6>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 40%;">Nome:</td>
                                    <td id="name">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Gerente:</td>
                                    <td id="manager">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Departamento Superior:</td>
                                    <td id="higherDepartament">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Data de Criação:</td>
                                    <td id="createdAt">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Última Atualização:</td>
                                    <td id="updatedAt">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4">
                    <h6 class="text-muted mb-3">Subdepartamentos</h6>
                    <div id="subDepartamentsContainer">
                        <p class="text-muted">Carregando subdepartamentos...</p>
                    </div>
                </div>

                <div class="mt-4">
                    <h6 class="text-muted mb-3">Colaboradores do Departamento</h6>
                    <div id="employeesContainer">
                        <p class="text-muted">Carregando colaboradores...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
        <h4 class="alert-heading">Erro ao carregar departamento</h4>
        <p id="errorText"></p>
        <hr>
        <a href="/Departament" class="btn btn-outline-danger">Voltar para lista</a>
    </div>
</div>

@section Scripts {
    <script>
        const departamentId = @(ViewBag.DepartamentId ?? 0);
        const apiUrl = departamentId && departamentId !== 0 ? `/api/departaments/${departamentId}` : '';

        function showError(message) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const departamentDetails = document.getElementById('departamentDetails');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (departamentDetails) departamentDetails.style.display = 'none';
            if (errorText) errorText.textContent = message;
            if (errorMessage) errorMessage.style.display = 'block';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        function renderSubDepartaments(subDepartaments) {
            const container = document.getElementById('subDepartamentsContainer');
            if (!container) return;
            
            if (!subDepartaments || subDepartaments.length === 0) {
                container.innerHTML = '<p class="text-muted">Este departamento não possui subdepartamentos.</p>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Gerente</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            subDepartaments.forEach(subDept => {
                html += `
                    <tr>
                        <td>${escapeHtml(subDept.name || '-')}</td>
                        <td>${escapeHtml(subDept.manager?.name || 'Sem gerente')}</td>
                        <td>
                            <a href="/Departament/Details/${subDept.id}" class="btn btn-sm btn-outline-info" title="Ver detalhes">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                                </svg>
                            </a>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderEmployees(employees) {
            const container = document.getElementById('employeesContainer');
            if (!container) return;
            
            if (!employees || employees.length === 0) {
                container.innerHTML = '<p class="text-muted">Este departamento não possui colaboradores cadastrados.</p>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>RG</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            employees.forEach(employee => {
                html += `
                    <tr>
                        <td>${escapeHtml(employee.name || '-')}</td>
                        <td>${escapeHtml(employee.cpf || '-')}</td>
                        <td>${escapeHtml(employee.rg || '-')}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        async function loadDepartamentDetails() {
            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('Departamento não encontrado.');
                    } else {
                        const errorText = await response.text();
                        showError(`Erro ao carregar departamento. Status: ${response.status}. ${errorText}`);
                    }
                    return;
                }

                const departament = await response.json();

                const titleContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4 > div');
                if (titleContainer) {
                    const titleElement = titleContainer.querySelector('h1');
                    const subtitleElement = titleContainer.querySelector('p');
                    if (titleElement) {
                        titleElement.textContent = 'Detalhes do Departamento';
                    }
                    if (subtitleElement) {
                        subtitleElement.textContent = departament.name || 'Departamento';
                    }
                }

                const nameElement = document.getElementById('departamentName');
                const nameDetailElement = document.getElementById('name');
                if (nameElement) nameElement.textContent = departament.name || '-';
                if (nameDetailElement) nameDetailElement.textContent = departament.name || '-';
                
                const managerElement = document.getElementById('manager');
                if (managerElement) {
                    const managerName = (departament.manager && departament.manager.name) 
                        ? departament.manager.name 
                        : 'Sem gerente';
                    managerElement.textContent = managerName;
                }
                
                const higherElement = document.getElementById('higherDepartament');
                if (higherElement) {
                    const higherDepartamentName = (departament.higherDepartament && departament.higherDepartament.name)
                        ? departament.higherDepartament.name
                        : 'Nenhum';
                    higherElement.textContent = higherDepartamentName;
                }
                
                const createdAtElement = document.getElementById('createdAt');
                const updatedAtElement = document.getElementById('updatedAt');
                if (createdAtElement) createdAtElement.textContent = formatDate(departament.createdAt);
                if (updatedAtElement) updatedAtElement.textContent = formatDate(departament.updatedAt);

                let subDepartaments = [];
                if (departament.subDepartaments && Array.isArray(departament.subDepartaments)) {
                    subDepartaments = departament.subDepartaments.filter(dept => dept !== null && dept !== undefined);
                }
                renderSubDepartaments(subDepartaments);

                let employees = [];
                if (departament.employees && Array.isArray(departament.employees)) {
                    employees = departament.employees.filter(emp => emp !== null && emp !== undefined);
                }
                renderEmployees(employees);

                const loadingSpinner = document.getElementById('loadingSpinner');
                const departamentDetails = document.getElementById('departamentDetails');
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (departamentDetails) departamentDetails.style.display = 'block';

            } catch (error) {
                console.error('Erro ao carregar departamento:', error);
                showError('Erro ao carregar os dados do departamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (departamentId && departamentId !== 0) {
                loadDepartamentDetails();
            } else {
                showError('ID do departamento não fornecido.');
            }
        });
    </script>
}
