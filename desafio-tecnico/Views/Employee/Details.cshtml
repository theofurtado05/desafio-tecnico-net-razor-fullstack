@{
    ViewData["Title"] = "Detalhes do Colaborador";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0 fw-bold">Detalhes do Colaborador</h1>
            <p class="mt-2 text-muted">Carregando...</p>
        </div>
        <a href="/Employee" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
            </svg>
            Voltar
        </a>
    </div>

    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3 text-muted">Carregando dados do colaborador...</p>
    </div>

    <div id="employeeDetails" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0" id="employeeName">-</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Informações Pessoais</h6>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 40%;">Nome:</td>
                                    <td id="name">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">CPF:</td>
                                    <td id="cpf">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">RG:</td>
                                    <td id="rg">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Departamento:</td>
                                    <td id="departament">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Data de Criação:</td>
                                    <td id="createdAt">-</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Última Atualização:</td>
                                    <td id="updatedAt">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
        <h4 class="alert-heading">Erro ao carregar colaborador</h4>
        <p id="errorText"></p>
        <hr>
        <a href="/Employee" class="btn btn-outline-danger">Voltar para lista</a>
    </div>
</div>

@section Scripts {
    <script>
        const employeeId = @(ViewBag.EmployeeId ?? 0);
        const apiUrl = employeeId && employeeId !== 0 ? `/api/employees/${employeeId}` : '';

        function showError(message) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const employeeDetails = document.getElementById('employeeDetails');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (employeeDetails) employeeDetails.style.display = 'none';
            if (errorText) errorText.textContent = message;
            if (errorMessage) errorMessage.style.display = 'block';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatCPF(cpf) {
            if (!cpf) return '-';
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        async function loadEmployeeDetails() {
            if (!apiUrl || !employeeId || employeeId === 0) {
                showError('ID do colaborador não fornecido.');
                return;
            }

            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('Colaborador não encontrado.');
                    } else {
                        let errorText = '';
                        try {
                            errorText = await response.text();
                        } catch (e) {
                            errorText = 'Erro desconhecido';
                        }
                        showError(`Erro ao carregar colaborador. Status: ${response.status}. ${errorText}`);
                    }
                    return;
                }

                const employee = await response.json();

                const titleContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4 > div');
                if (titleContainer) {
                    const titleElement = titleContainer.querySelector('h1');
                    const subtitleElement = titleContainer.querySelector('p');
                    if (titleElement) {
                        titleElement.textContent = 'Detalhes do Colaborador';
                    }
                    if (subtitleElement) {
                        subtitleElement.textContent = employee.name || 'Colaborador';
                    }
                }

                const nameElement = document.getElementById('employeeName');
                const nameDetailElement = document.getElementById('name');
                if (nameElement) nameElement.textContent = employee.name || '-';
                if (nameDetailElement) nameDetailElement.textContent = employee.name || '-';
                
                const cpfElement = document.getElementById('cpf');
                if (cpfElement) cpfElement.textContent = formatCPF(employee.cpf);
                
                const rgElement = document.getElementById('rg');
                if (rgElement) rgElement.textContent = employee.rg || '-';
                
                const departamentElement = document.getElementById('departament');
                if (departamentElement) {
                    const departamentName = (employee.departament && employee.departament.name)
                        ? employee.departament.name
                        : 'Sem departamento';
                    departamentElement.textContent = departamentName;
                }
                
                const createdAtElement = document.getElementById('createdAt');
                const updatedAtElement = document.getElementById('updatedAt');
                if (createdAtElement) createdAtElement.textContent = formatDate(employee.createdAt);
                if (updatedAtElement) updatedAtElement.textContent = formatDate(employee.updatedAt);

                const loadingSpinner = document.getElementById('loadingSpinner');
                const employeeDetails = document.getElementById('employeeDetails');
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (employeeDetails) employeeDetails.style.display = 'block';

            } catch (error) {
                console.error('Erro ao carregar colaborador:', error);
                showError('Erro ao carregar os dados do colaborador: ' + (error.message || 'Erro desconhecido'));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (employeeId && employeeId !== 0) {
                loadEmployeeDetails();
            } else {
                showError('ID do colaborador não fornecido.');
            }
        });
    </script>
}
